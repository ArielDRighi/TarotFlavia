name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancelar ejecuciones anteriores del mismo workflow en el mismo branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # JOB 1: Linting y Formateo (R√°pido)
  # ============================================================================
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    # Solo en PRs y pushes a develop/main
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm' # ‚ö° Cache de npm para acelerar instalaci√≥n

      - name: Install dependencies (monorepo root)
        run: npm ci # ‚ö° Usar ci en vez de install (m√°s r√°pido y determinista)

      - name: Run ESLint
        working-directory: ./backend/tarot-app
        run: npm run lint

      - name: Check code formatting with Prettier
        working-directory: ./backend/tarot-app
        run: npm run format -- --check

  # ============================================================================
  # JOB 2: TypeScript Type Check (R√°pido)
  # ============================================================================
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies (monorepo root)
        run: npm ci

      - name: Type check with TypeScript
        working-directory: ./backend/tarot-app
        run: npx tsc --noEmit

  # ============================================================================
  # JOB 3: Build (R√°pido)
  # ============================================================================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies (monorepo root)
        run: npm ci

      - name: Build application
        working-directory: ./backend/tarot-app
        run: npm run build

      # ‚ö° Opcional: Comentar si no necesitas el artifact
      # - name: Upload build artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dist-backend
      #     path: backend/tarot-app/dist
      #     retention-days: 1

  # ============================================================================
  # JOB 4: Unit Tests (Moderado)
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check]

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
        ports:
          - 5436:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies (monorepo root)
        run: npm ci

      - name: Run database migrations for unit tests
        working-directory: ./backend/tarot-app
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5436
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
          TAROT_DB_HOST: localhost
          TAROT_DB_PORT: 5436
          TAROT_DB_USER: tarot_test_user
          TAROT_DB_PASSWORD: tarot_test_pass
          TAROT_DB_NAME: tarot_test
          TAROT_E2E_DB_HOST: localhost
          TAROT_E2E_DB_PORT: 5436
          TAROT_E2E_DB_USER: tarot_test_user
          TAROT_E2E_DB_PASSWORD: tarot_test_pass
          TAROT_E2E_DB_NAME: tarot_test
          JWT_SECRET: test-jwt-secret-for-ci-only-minimum-32-characters-required
          JWT_EXPIRES_IN: 1h
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          NODE_ENV: test
        run: npm run migration:run

      - name: Run unit tests with coverage
        working-directory: ./backend/tarot-app
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5436
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
          TAROT_DB_HOST: localhost
          TAROT_DB_PORT: 5436
          TAROT_DB_USER: tarot_test_user
          TAROT_DB_PASSWORD: tarot_test_pass
          TAROT_DB_NAME: tarot_test
          TAROT_E2E_DB_HOST: localhost
          TAROT_E2E_DB_PORT: 5436
          TAROT_E2E_DB_USER: tarot_test_user
          TAROT_E2E_DB_PASSWORD: tarot_test_pass
          TAROT_E2E_DB_NAME: tarot_test
          JWT_SECRET: test-jwt-secret-for-ci-only-minimum-32-characters-required
          JWT_EXPIRES_IN: 1h
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENAI_API_KEY: sk-test-key-for-ci-only-not-real-12345
          DEEPSEEK_API_KEY: sk-test-key-for-ci-only-not-real-12345
          NODE_ENV: test
          PORT: 3000
          CI: true
        run: npm run test -- --coverage --maxWorkers=2 --testPathIgnorePatterns=test/integration

      # ‚ö° Solo guardar coverage en main/develop, no en PRs
      - name: Upload coverage artifact
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit-tests
          path: backend/tarot-app/coverage
          retention-days: 7

      - name: Upload coverage to Codecov
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/tarot-app/coverage/lcov.info
          flags: unittests
          name: unit-tests-coverage
        continue-on-error: true

  # ============================================================================
  # JOB 4.5: Integration Tests (Moderado)
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check]
    # ‚ö° Solo en main/develop, NO en PRs (opcional)
    # if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
        ports:
          - 5436:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies (monorepo root)
        run: npm ci

      - name: Run database migrations
        working-directory: ./backend/tarot-app
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5436
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
          TAROT_DB_HOST: localhost
          TAROT_DB_PORT: 5436
          TAROT_DB_USER: tarot_test_user
          TAROT_DB_PASSWORD: tarot_test_pass
          TAROT_DB_NAME: tarot_test
          TAROT_E2E_DB_HOST: localhost
          TAROT_E2E_DB_PORT: 5436
          TAROT_E2E_DB_USER: tarot_test_user
          TAROT_E2E_DB_PASSWORD: tarot_test_pass
          TAROT_E2E_DB_NAME: tarot_test
          JWT_SECRET: test-jwt-secret-for-ci-only-minimum-32-characters-required
          JWT_EXPIRES_IN: 1h
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          NODE_ENV: test
        run: npm run migration:run

      - name: Run integration tests with coverage
        working-directory: ./backend/tarot-app
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5436
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
          TAROT_DB_HOST: localhost
          TAROT_DB_PORT: 5436
          TAROT_DB_USER: tarot_test_user
          TAROT_DB_PASSWORD: tarot_test_pass
          TAROT_DB_NAME: tarot_test
          TAROT_E2E_DB_HOST: localhost
          TAROT_E2E_DB_PORT: 5436
          TAROT_E2E_DB_USER: tarot_test_user
          TAROT_E2E_DB_PASSWORD: tarot_test_pass
          TAROT_E2E_DB_NAME: tarot_test
          JWT_SECRET: test-jwt-secret-for-ci-only-minimum-32-characters-required
          JWT_EXPIRES_IN: 1h
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENAI_API_KEY: sk-test-key-for-ci-only-not-real-12345
          DEEPSEEK_API_KEY: sk-test-key-for-ci-only-not-real-12345
          NODE_ENV: test
          PORT: 3000
          CI: true
        run: npm run test:integration -- --coverage --maxWorkers=2

      - name: Upload integration coverage artifact
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration-tests
          path: backend/tarot-app/coverage-integration
          retention-days: 7

  # ============================================================================
  # JOB 5: E2E Tests - SOLO EN PRs HACIA MAIN
  # ============================================================================
  # E2E tests se ejecutan ANTES de mergear a main (pre-merge)
  # De esta forma garantizamos que main siempre funciona correctamente
  
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build, unit-tests, integration-tests]
    # ‚úÖ Solo en Pull Requests cuyo destino es main
    if: github.event_name == 'pull_request' && github.base_ref == 'main'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
        ports:
          - 5436:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies (monorepo root)
        run: npm ci

      - name: Run database migrations
        working-directory: ./backend/tarot-app
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5436
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
          TAROT_DB_HOST: localhost
          TAROT_DB_PORT: 5436
          TAROT_DB_USER: tarot_test_user
          TAROT_DB_PASSWORD: tarot_test_pass
          TAROT_DB_NAME: tarot_test
          TAROT_E2E_DB_HOST: localhost
          TAROT_E2E_DB_PORT: 5436
          TAROT_E2E_DB_USER: tarot_test_user
          TAROT_E2E_DB_PASSWORD: tarot_test_pass
          TAROT_E2E_DB_NAME: tarot_test
          TAROT_E2E_DB_SYNCHRONIZE: false
          TAROT_E2E_DB_LOGGING: false
          JWT_SECRET: test-jwt-secret-for-ci-only-minimum-32-characters-required
          JWT_EXPIRES_IN: 1h
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          NODE_ENV: test
        run: npm run migration:run

      - name: Run E2E tests
        working-directory: ./backend/tarot-app
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5436
          POSTGRES_USER: tarot_test_user
          POSTGRES_PASSWORD: tarot_test_pass
          POSTGRES_DB: tarot_test
          TAROT_DB_HOST: localhost
          TAROT_DB_PORT: 5436
          TAROT_DB_USER: tarot_test_user
          TAROT_DB_PASSWORD: tarot_test_pass
          TAROT_DB_NAME: tarot_test
          TAROT_E2E_DB_HOST: localhost
          TAROT_E2E_DB_PORT: 5436
          TAROT_E2E_DB_USER: tarot_test_user
          TAROT_E2E_DB_PASSWORD: tarot_test_pass
          TAROT_E2E_DB_NAME: tarot_test
          TAROT_E2E_DB_SYNCHRONIZE: false
          TAROT_E2E_DB_LOGGING: false
          JWT_SECRET: test-jwt-secret-for-ci-only-minimum-32-characters-required
          JWT_EXPIRES_IN: 1h
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENAI_API_KEY: sk-test-key-for-ci-only-not-real-12345
          DEEPSEEK_API_KEY: sk-test-key-for-ci-only-not-real-12345
          NODE_ENV: test
          PORT: 3001
          RATE_LIMIT_TTL: 60
          RATE_LIMIT_MAX: 1000
          CI: true
        run: npm run test:e2e -- --maxWorkers=1

      - name: Upload E2E test results on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-results
          path: backend/tarot-app/test-results
          retention-days: 3

  # ============================================================================
  # JOB 6: Security Audit (Opcional en PRs)
  # ============================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    # ‚ö° Solo en main/develop
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Run npm audit
        working-directory: ./backend/tarot-app
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # ============================================================================
  # JOB 7: Summary
  # ============================================================================
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs: [build, unit-tests, integration-tests]
    if: success()

    steps:
      - name: CI Pipeline Passed
        run: |
          echo "‚úÖ All CI checks passed successfully!"
          echo "- Linting & Formatting: ‚úì"
          echo "- Type Checking: ‚úì"
          echo "- Build: ‚úì"
          echo "- Unit Tests: ‚úì"
          echo "- Integration Tests: ‚úì"
          echo ""
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "üé™ E2E tests are running (PR to main)"
          elif [[ "${{ contains(github.event.pull_request.labels.*.name, 'run-e2e') }}" == "true" ]]; then
            echo "üé™ E2E tests are running (label: run-e2e)"
          else
            echo "‚ÑπÔ∏è  E2E tests skipped (add 'run-e2e' label to run)"
            echo "   Or merge to main to trigger E2E validation"
          fi
