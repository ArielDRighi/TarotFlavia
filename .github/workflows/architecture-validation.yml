name: Architecture Validation

on:
    pull_request:
        branches: [develop, main]
        paths:
            - "backend/tarot-app/src/**"
            - "backend/tarot-app/test/**"
            - "backend/tarot-app/package.json"

jobs:
    validate-architecture:
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: backend/tarot-app

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: backend/tarot-app/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Validate module structure
              run: node scripts/validate-architecture.js

            - name: Check circular dependencies
              run: |
                  npm install -g madge
                  madge --circular --extensions ts src/ && echo "✅ No circular dependencies"

            - name: Run linter
              run: npm run lint

            - name: Run build
              run: npm run build

            - name: Run tests with coverage
              run: npm run test:cov

            - name: Check coverage threshold
              run: |
                  COVERAGE=$(node -pe "require('./coverage/coverage-summary.json').total.lines.pct")
                  echo "Coverage: $COVERAGE%"
                  if awk "BEGIN {exit !($COVERAGE < 80)}"; then
                    echo "❌ Coverage below 80%: $COVERAGE%"
                    exit 1
                  fi

            - name: Upload coverage reports
              uses: codecov/codecov-action@v3
              with:
                  files: ./backend/tarot-app/coverage/lcov.info
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
