name: E2E Tests (Manual Trigger)

# Permite ejecutar E2E tests manualmente desde GitHub UI
# Útil para: verificar E2E antes de merge crítico, testing de hotfix, validación de release
on:
    workflow_dispatch:
        inputs:
            branch:
                description: "Branch to test (default: current branch)"
                required: false
                default: ""
            maxWorkers:
                description: "Max parallel workers (1=sequential, 2=parallel)"
                required: false
                default: "1"
                type: choice
                options:
                    - "1"
                    - "2"

jobs:
    e2e-manual:
        name: E2E Tests on ${{ github.event.inputs.branch || github.ref_name }}
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_USER: tarot_test_user
                    POSTGRES_PASSWORD: tarot_test_pass
                    POSTGRES_DB: tarot_test
                ports:
                    - 5436:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.branch || github.ref }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run database migrations
              working-directory: ./backend/tarot-app
              env:
                  POSTGRES_HOST: localhost
                  POSTGRES_PORT: 5436
                  POSTGRES_USER: tarot_test_user
                  POSTGRES_PASSWORD: tarot_test_pass
                  POSTGRES_DB: tarot_test
                  TAROT_DB_HOST: localhost
                  TAROT_DB_PORT: 5436
                  TAROT_DB_USER: tarot_test_user
                  TAROT_DB_PASSWORD: tarot_test_pass
                  TAROT_DB_NAME: tarot_test
                  TAROT_E2E_DB_HOST: localhost
                  TAROT_E2E_DB_PORT: 5436
                  TAROT_E2E_DB_USER: tarot_test_user
                  TAROT_E2E_DB_PASSWORD: tarot_test_pass
                  TAROT_E2E_DB_NAME: tarot_test
                  TAROT_E2E_DB_SYNCHRONIZE: false
                  TAROT_E2E_DB_LOGGING: false
                  JWT_SECRET: test-jwt-secret-for-ci-only-minimum-32-characters-required
                  JWT_EXPIRES_IN: 1h
                  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
                  NODE_ENV: test
              run: npm run migration:run

            - name: Run E2E tests
              working-directory: ./backend/tarot-app
              env:
                  POSTGRES_HOST: localhost
                  POSTGRES_PORT: 5436
                  POSTGRES_USER: tarot_test_user
                  POSTGRES_PASSWORD: tarot_test_pass
                  POSTGRES_DB: tarot_test
                  TAROT_DB_HOST: localhost
                  TAROT_DB_PORT: 5436
                  TAROT_DB_USER: tarot_test_user
                  TAROT_DB_PASSWORD: tarot_test_pass
                  TAROT_DB_NAME: tarot_test
                  TAROT_E2E_DB_HOST: localhost
                  TAROT_E2E_DB_PORT: 5436
                  TAROT_E2E_DB_USER: tarot_test_user
                  TAROT_E2E_DB_PASSWORD: tarot_test_pass
                  TAROT_E2E_DB_NAME: tarot_test
                  TAROT_E2E_DB_SYNCHRONIZE: false
                  TAROT_E2E_DB_LOGGING: false
                  JWT_SECRET: test-jwt-secret-for-ci-only-minimum-32-characters-required
                  JWT_EXPIRES_IN: 1h
                  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
                  OPENAI_API_KEY: sk-test-key-for-ci-only-not-real-12345
                  DEEPSEEK_API_KEY: sk-test-key-for-ci-only-not-real-12345
                  NODE_ENV: test
                  PORT: 3001
                  RATE_LIMIT_TTL: 60
                  RATE_LIMIT_MAX: 1000
                  CI: true
              run: npm run test:e2e -- --maxWorkers=${{ github.event.inputs.maxWorkers || '1' }}

            - name: Upload E2E test results
              uses: actions/upload-artifact@v4
              if: failure()
              with:
                  name: e2e-test-results-manual-${{ github.run_number }}
                  path: backend/tarot-app/test-results
                  retention-days: 7

            - name: Comment on PR (if from PR)
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request' && failure()
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: '❌ E2E tests failed. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
                      })

            - name: Success summary
              if: success()
              run: |
                  echo "✅ E2E Tests passed successfully!"
                  echo "Branch: ${{ github.event.inputs.branch || github.ref_name }}"
                  echo "Workers: ${{ github.event.inputs.maxWorkers || '1' }}"
                  echo "Total suites: 41"
